<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
     fbq('init', '192998336855239'); 
    fbq('track', 'PageView');
    </script>
    <noscript>
     <img height="1" width="1" 
    src="https://www.facebook.com/tr?id=192998336855239&ev=PageView
    &noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->
<% if(products.cart.length> 0) { %>
    <section class="cart py-20 min-h-full md:flex " style="background-color: white;  ">
        <div class="order  container mx-auto xl:w-2/3">
            <div class="flex items-center  pb-4">
                <!-- <img src="https://svgsilh.com/svg/151889.svg" class="w-10 block pr-2"> -->
                <lottie-player src="https://assets9.lottiefiles.com/packages/lf20_bpoxfowy.json"
                    background="transparent" speed="1" style="width: 100px; height: 100px;" loop autoplay>
                </lottie-player>

                <h1 class="text-xl font-medium -ml-5 ">Order summary</h1>
            </div>
            <% products.cart.forEach((product)=> { %>
                <div class="flex justify-between items-center">
                    <div class="flex  w-1/2">
                        <a href="/productDetails/<%= product.product.pname %>/<%= product.product._id %>/1" >
                            <img src="/img/<%= product.product.image[0].imgName %> %>" width="80" >
                        </a>
                        <div class="flex flex-col ml-3">

                            <% if(product.product.variationname !='-' && product.product.variationname !='undefined' &&
                                product.product.variationname !=null) { %>
                                <span class="text-sm md:text-lg font-medium  w-20 sm:w-full">
                                    <%= product.product.pname %> - <%= product.product.variationname %>
                                </span>
                                <% } else { %>
                                    <span class="text-sm md:text-lg font-medium w-20 sm:w-full">
                                        <%= product.product.pname %>
                                    </span>
                                    <% } %>

                                        <span class="text-xs font-medium text-gray-600   ">
                                            <%= product.product.brand.name %>
                                        </span>

                        </div>
                    </div>

                    <div class="flex justify-end items-center w-44 sm:w-1/2">

                        <div class="flex px-1 sm:px-6">
                            <button onclick="updateQuantity('minus', '<%= product.product._id %>', '0')"
                                class="font-semibold md:text-lg">-</button>
                            <input type="number" min="1"
                                class="focus:outline-none bg-gray-100 border h-6 w-12 rounded text-sm md:text-lg text-center m-2 sm:m-4"
                                id="<%= product.product._id %>1"
                                onfocusout="updateQuantity('specific', '<%= product.product._id %>', this.value)"
                                value="<%= product.quantity %>">
                            <button onclick="updateQuantity('plus', '<%= product.product._id %>', '0')"
                                class="font-semibold md:text-lg   ">+</button>
                        </div>

                        <div style="width: 95px;" class="flex flex-row justify-between">
                            <div class="text-center p-1 sm:p-3">
                                <span class="ml-2 subtotal text-sm font-medium md:text-md sm:font-bold" id="<%= product.product._id %>">
                                    ₹<%= Math.ceil((product.product.price * product.product.piecePerPack *
                                        product.quantity) - ((product.product.price * product.product.piecePerPack *
                                        product.quantity)* (product.product.brand.discount/100))) %></span>
                            </div>
                            <div class="text-center p-2 flex items-center justify-center">
                                <button onclick="removeItem('<%= product.product._id %>')"
                                    class="fa fa-close text-xs font-medium"></button>
                            </div>
                        </div>

                    </div>

                </div>
                

                    <hr class="mt-4 mb-2">
                    <% }) %>
                        <div class="text-right py-6 ">

                            <div class=" text-right py-6 items-end">
                                <div class="float-left items-center mt-1">
                                    <a href="/allcategory" rel="noopener noreferrer">
                                    <button class="flex items-center">
                                        <i class="fa fa-arrow-left text-sm pr-2"></i>
                                        <span class="text-md  font-medium text-blue-500">Continue Shopping</span>
                                    </button>
                                </a>
                                </div>
                                <div id="subtotal" class="float-right">
                                    <span class="text-sm font-medium text-gray-400 mr-1">Subtotal:</span>
                                    <% var sum=0; %>
                                        <% products.cart.forEach((product)=> { %>
                                            <% sum +=Math.ceil(((product.product.price * product.product.piecePerPack *
                                                product.quantity) - ((product.product.price *
                                                product.product.piecePerPack * product.quantity)*
                                                (product.product.brand.discount/100)))) %>
                                                <% }) %>
                                                    <span class="text-lg font-bold text-gray-800 "> ₹<%= sum %></span>
                                </div>
                            </div>
                        </div>
                            <% if(user) { %>
                                <div class="flex py-8 justify-center">
                                    <a href="/customer/checkout"><button
                                            class="h-12 w-48 bg-blue-500 rounded focus:outline-none text-white ">Checkout</button></a>
                                    </div >
                                <div id="warningText">
                                <%if(sum < 1000 ){%>


                                    <div class="text-center py-4 lg:px-4">
                                        <div class="p-2 bg-indigo-800 items-center text-indigo-100 leading-none lg:rounded-full flex lg:inline-flex" role="alert">
                                          <svg class="fill-current opacity-75 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.95 10.707l.707-.707L8 4.343 6.586 5.757 10.828 10l-4.242 4.243L8 15.657l4.95-4.95z"/></svg>
                                          <!-- <span class="font-semibold mr-2 text-left flex-auto">Limited Offer</span> -->
                                          <span class="flex justify-center items-center rounded-full bg-indigo-500 uppercase px-2 py-1 text-xs font-semibold mr-3">Shop products worth<span class="font-bold mx-2 text-sm"> ₹ <%= 1000 - sum %> </span> or more to avail free delivery.</span>
                                        </div>
                                      </div>

                                    <%} } else { %>
                                        <a href="/login"
                                            class="inline-block cursor-pointer btn-primary px-6 py-2 rounded-full text-white font-bold mt-6">Login
                                            to continue</a>
                                        <% } %>
                                    </div>
                        
                
        </div>
        <!-- <div class="flex flex-col w-full ml-0 px-4 lg:w-1/5">
        <div class="pt-12 md:pt-0 2xl:ps-4">
            <section style="font-family: 'Abel', sans-serif;" class="form-step shadow-sm bg-white">
                <h2 class="font-semibold">Payment Summary</h2>

                <div class="flex items-center w-full py-4  text-sm font-black border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                    <span class=" w-1/2"> Item Total </span>
                    <span class="pl-2 w-1/2">₹<%= session.total %></span>
                </div>
                <div class="flex items-center w-full py-4 text-sm font-semibold border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                    <span class=" w-1/2"> Processing Fee </span>
                    <span class="pl-2 w-1/2">₹</span>
                </div>
                <div class="flex items-center w-full py-4 text-sm font-semibold border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                    <span class=" w-1/2"> Taxes </span>
                    <span class="pl-2 w-1/2">₹</span>
                </div>
                <div class="flex items-center w-full py-4 text-sm font-semibold border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                    <span class=" w-1/2"> Delivery Charges </span>
                    <span class="pl-2 w-1/2">₹<%= session.delivery %></span>
                </div>
                <div class="flex items-center w-full py-4 text-sm font-semibold border-b border-gray-300 lg:py-5 lg:px-3 text-heading last:border-b-0 last:text-base last:pb-0">
                    <span class=" w-1/2"> Total </span>
                    <span class="pl-2 w-1/2">₹</span>
                </div>

            </section>
            </div>
            </div> -->

    </section>
    <% } else { %>
        <section class="cart py-1 min-h-5/6 " style="background-color: white;  ">
            <div class=" py-8">
                <div class=" container mx-auto text-center">
                    <h1 class="text-3xl font-bold mb-2">Cart Empty 😕</h1>
                    <p class="text-gray-500 text-md">You probably haven't ordered anything yet. <br>
                        To order your requirement, go to the main page.</p>
                    <div class="flex justify-center">
                        <lottie-player class="w-64 sm:w-96 md:w-4/12 "
                            src="https://assets3.lottiefiles.com/private_files/lf30_oqpbtola.json"
                            background="transparent" speed="1" loop autoplay></lottie-player>
                    </div>

                    <div class="">
                        <a href="/allcategory"><button
                                class="h-12 w-56 bg-blue-500 rounded focus:outline-none text-white ">Continue
                                Shopping</button></a>
                    </div>
                </div>
            </div>

        </section>
        <% } %>

            <script>


                function removeItem(itemId) {

                    var params = {
                        pid: itemId,
                    }

                    $.ajax({
                        type: 'POST',
                        url: '/remove-cart',
                        data: params,
                        dataType: 'json',
                        encode: true
                    }).done(function (result) {
                        if (result.status == "success") {
                            location.reload();
                        }
                    })
                }
                function updateQuantity(type, pid, qty) {
                    var params = {
                        type: type,
                        pid: pid,
                        qty: qty
                    }
                    $.ajax({
                        type: 'POST',
                        url: '/qty-cart',
                        data: params,
                        dataType: 'json',
                        encode: true
                    }).done(function (result) {
                        if (result.status == "success") {
                            if (type === 'plus') {
                                let value = parseInt(document.getElementById(pid + '1').value);
                                document.getElementById(pid + '1').value = value + 1;
                                $("#" + pid).load(window.location.href + " #" + pid);
                               

                            }
                            if (type === 'minus') {
                                let value = parseInt(document.getElementById(pid + '1').value);
                                if (value > 1) {
                                    document.getElementById(pid + '1').value = value - 1;
                                    $("#" + pid).load(window.location.href + " #" + pid);
                                   

                                }
                            }
                            if (type === 'specific') {
                                let value = parseInt(document.getElementById(pid + '1').value);
                                if (value <= 0) {
                                    document.getElementById(pid + '1').value = 1;
                                    $("#" + pid).load(window.location.href + " #" + pid);
                                    
                                } else {
                                    document.getElementById(pid + '1').value = value;
                                  

                                }
                            }
                            $("#subtotal").load(window.location.href + " #subtotal");
                            $("#warningText").load(window.location.href + " #warningText");

                        }
                    })
                }
            </script>